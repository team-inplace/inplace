name: Java CI with Gradle

# main 브랜치에 push가 발생할 경우 동작한다.
on:
  push:
    branches: [ "main" ]
    paths:
      - 'backend/**'
      - '.github/**'

permissions:
  contents: read
  id-token: write

jobs:
  # Spring Boot 애플리케이션을 빌드하여 도커허브에 푸시하는 과정
  build-docker-image:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      # Java 17 세팅
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # Gradle Wrapper 파일 실행 권한 주기
      - name: Run chmod to make gradlew executable
        working-directory: ./backend
        run: chmod +x ./gradlew

      - name: Create FCM key file
        working-directory: ./backend
        run: |
          mkdir -p inplace-api/src/main/resources/key
          echo "${{ secrets.FCM_KEY_JSON }}" > inplace-api/src/main/resources/key/firebase-admin-sdk.json
          
      # Spring Boot 애플리케이션 빌드
      - name: Build with Gradle
        uses: gradle/gradle-build-action@67421db6bd0bf253fb4bd25b31ebb98943c375e1
        with:
          arguments: clean :inplace-api:bootJar
          build-root-directory: ./backend

      # 테스트 실행
      #    - name: Run tests
      #      run: ./gradlew test

      # Docker 이미지 빌드
      - name: docker image build
        working-directory: ./backend
        run: docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/inplace .

      # DockerHub 로그인
      - name: docker login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      # Docker Hub 이미지 푸시
      - name: docker Hub push
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/inplace

  run-docker-image-on-ec2:
    needs: build-docker-image
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/heads/main')
    steps:
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh/
          echo "${{ secrets.SSH_PRODUCTION_SERVER_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST_PRODUCTION_SERVER }} >> ~/.ssh/known_hosts

      - name: Create and Copy .env file
        run: |
          echo "${{ secrets.ENV_PRODUCTION_SERVER }}" > .env
          scp .env ubuntu@${{ secrets.EC2_HOST_PRODUCTION_SERVER }}:/home/ubuntu/.env
          rm .env

      - name: Latest Docker Image Pull
        run: |
          ssh ubuntu@${{ secrets.EC2_HOST_PRODUCTION_SERVER }} "sudo docker pull ${{ secrets.DOCKERHUB_USERNAME }}/inplace"

      - name: Stop and Rename Existing Container
        run: |
          ssh ubuntu@${{ secrets.EC2_HOST_PRODUCTION_SERVER }} "
            if [ \$(sudo docker ps -aq --filter name=inplace) ]; then
              echo 'Found existing container. Stopping and renaming existing container to inplace-old'
              sudo docker stop inplace || true
              sudo docker rename inplace inplace-old
            else
              echo 'No existing container found. Skipping stop/rename.'
            fi
          "

      - name: Run New Container
        run: |
          ssh ubuntu@${{ secrets.EC2_HOST_PRODUCTION_SERVER }} "sudo docker run --name inplace -d -p 8080:8080 -p ${{ secrets.EC2_MONITORING_PORT }}:${{ secrets.EC2_MONITORING_PORT }} --env-file /home/ubuntu/.env ${{ secrets.DOCKERHUB_USERNAME }}/inplace"

      - name: Health Check
        run: |
          for i in {1..40}; do
            if ssh ubuntu@${{ secrets.EC2_HOST_PRODUCTION_SERVER }} "curl -s http://localhost:${{ secrets.EC2_HEALTH_CHECK_PATH }} | grep '\"status\":\"UP\"' > /dev/null"; then
              echo "Application is healthy"
              break
            fi
            echo "Waiting for new application to start... $i"
            sleep 5
          done
          if [ $i -eq 40 ]; then
            echo "Application failed to start after 40 attempts."
            exit 1
          fi            

      - name: Cleanup Old Container
        if: success()
        run: |
          ssh ubuntu@${{ secrets.EC2_HOST_PRODUCTION_SERVER }} "
            if [ \$(sudo docker ps -aq --filter name=inplace-old) ]; then
              echo 'Removing old container.'
              sudo docker rm inplace-old
            fi
          "

      - name: Rollback to Old Container
        if: failure()
        run: |
          ssh ubuntu@${{ secrets.EC2_HOST_PRODUCTION_SERVER }} "
            echo 'Rolling back to the previous version.'
            sudo docker stop inplace
            sudo docker rm inplace
          
            if [ \$(sudo docker ps -aq --filter name=inplace-old) ]; then
              echo 'Restoring old container.'
              sudo docker rename inplace-old inplace
              sudo docker start inplace
            fi
          "